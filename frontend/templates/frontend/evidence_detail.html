{% extends "frontend/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'frontend/public_research.css' %}">

<style>
  .detail-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0; }
  .detail-tab { flex: 1; min-width: 100px; padding: 0.75rem; background: #f8f9fa; border: none; border-radius: 8px 8px 0 0; cursor: pointer; transition: all 0.3s; font-weight: 500; color: #6c757d; font-size: 0.9rem; }
  .detail-tab:hover { background: #e9ecef; }
  .detail-tab.active { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44, 62, 80, 0.3); }
  .tab-content { display: none; animation: fadeIn 0.3s; }
  .tab-content.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<div class="container mt-4 mb-4">
    <div class="research-card mb-4">
        <div class="research-card-header d-flex justify-content-between align-items-start flex-wrap">
            <div>
                <h2 class="mb-1"><i class="fas fa-archway"></i>
                    {% if evidence.evidence_name %}{{ evidence.evidence_name }}{% else %}Evidence #{{ evidence.id }}{% endif %}
                </h2>
                {% if evidence.id_archaeological_evidence_typology %}
                    <span class="badge-modern">{{ evidence.id_archaeological_evidence_typology }}</span>
                {% endif %}
            </div>
            {% if user.is_authenticated %}
                <div class="btn-group">
                    <a href="{% url 'evidence_update' evidence.id %}" class="btn btn-warning-modern btn-modern btn-sm"><i class="fas fa-edit"></i> Edit</a>
                    <a href="{% url 'evidence_delete' evidence.id %}" class="btn btn-danger-modern btn-modern btn-sm"><i class="fas fa-trash"></i> Delete</a>
                </div>
            {% endif %}
        </div>
        
        <!-- Tabs Navigation -->
        <div class="detail-tabs">
            <button class="detail-tab active" onclick="showTab(event, 'general')"><i class="fas fa-info-circle"></i> General</button>
            <button class="detail-tab" onclick="showTab(event, 'desc')"><i class="fas fa-align-left"></i> Description</button>
            <button class="detail-tab" onclick="showTab(event, 'pos')"><i class="fas fa-map-pin"></i> Positioning</button>
            <button class="detail-tab" onclick="showTab(event, 'landscape')"><i class="fas fa-mountain"></i> Landscape</button>
            <button class="detail-tab" onclick="showTab(event, 'research')"><i class="fas fa-flask"></i> Research History</button>
            <button class="detail-tab" onclick="showTab(event, 'docs')"><i class="fas fa-file-alt"></i> Documentation</button>
            <button class="detail-tab" onclick="showTab(event, 'notes')"><i class="fas fa-sticky-note"></i> Notes</button>
        </div>

        <div class="research-card-body">
            
            <!-- General Tab -->
            <div id="general" class="tab-content active">
                <div class="detail-row">
                    {% if evidence.id_country %}<div class="detail-item"><strong><i class="fas fa-flag"></i> Country</strong> {{ evidence.id_country }}</div>{% endif %}
                    {% if evidence.id_region %}<div class="detail-item"><strong><i class="fas fa-map"></i> Region</strong> {{ evidence.id_region }}</div>{% endif %}
                    {% if evidence.id_province %}<div class="detail-item"><strong><i class="fas fa-map-marked-alt"></i> Province</strong> {{ evidence.id_province }}</div>{% endif %}
                    {% if evidence.id_municipality %}<div class="detail-item"><strong><i class="fas fa-city"></i> Municipality</strong> {{ evidence.id_municipality }}</div>{% endif %}
                </div>
            </div>

            <!-- Description Tab -->
            <div id="desc" class="tab-content">
                <div class="detail-row">
                    {% if evidence.id_archaeological_evidence_typology %}
                        <div class="detail-item"><strong><i class="fas fa-list"></i> Typology</strong> {{ evidence.id_archaeological_evidence_typology }}</div>
                    {% endif %}
                    {% if evidence.evidence_name %}
                        <div class="detail-item"><strong><i class="fas fa-tag"></i> Evidence Name</strong> {{ evidence.evidence_name }}</div>
                    {% endif %}
                </div>

                <div class="detail-row mt-2">
                    {% if evidence.description %}
                        <div class="detail-item">
                            <strong><i class="fas fa-align-left"></i> Description</strong>
                            <div>{{ evidence.description|linebreaksbr }}</div>
                        </div>
                    {% else %}
                        <div class="detail-item text-muted">
                            <strong><i class="fas fa-align-left"></i> Description</strong>
                            <div>No description recorded.</div>
                        </div>
                    {% endif %}
                </div>

                <div class="detail-row mt-2">
                    {% if evidence.id_chronology %}
                        <div class="detail-item"><strong><i class="fas fa-clock"></i> Chronology</strong> {{ evidence.id_chronology }}</div>
                    {% endif %}
                    {% if evidence.chronology_certainty_level %}
                        <div class="detail-item"><strong><i class="fas fa-check-circle"></i> Chronology Certainty Level</strong> {{ evidence.chronology_certainty_level }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Positioning Tab -->
            <div id="pos" class="tab-content">
                <div class="detail-row">
                    {% if evidence.lat and evidence.lon %}<div class="detail-item"><strong><i class="fas fa-globe"></i> Coordinates</strong> {{ evidence.lat }}, {{ evidence.lon }}</div>{% endif %}
                    {% if evidence.elevation %}<div class="detail-item"><strong><i class="fas fa-mountain"></i> Elevation</strong> {{ evidence.elevation }} m</div>{% endif %}
                    {% if evidence.id_positioning_mode %}<div class="detail-item"><strong><i class="fas fa-crosshairs"></i> Positioning Mode</strong> {{ evidence.id_positioning_mode }}</div>{% endif %}
                    {% if evidence.id_positional_accuracy %}<div class="detail-item"><strong><i class="fas fa-bullseye"></i> Accuracy</strong> {{ evidence.id_positional_accuracy }}</div>{% endif %}
                    {% if evidence.id_base_map %}<div class="detail-item"><strong><i class="fas fa-map"></i> Base Map</strong> {{ evidence.id_base_map }}</div>{% endif %}
                </div>
                                {% if evidence.lat and evidence.lon %}
                                <div class="mt-3">
                                    <h6><i class="fas fa-map"></i> Location Map</h6>
                                    <div id="evidence-map" data-lat="{{ evidence.lat }}" data-lon="{{ evidence.lon }}" style="height: 300px; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0;"></div>
                                </div>
                                {% endif %}
            </div>

            <!-- Landscape Tab -->
            <div id="landscape" class="tab-content">
                <div class="detail-row">
                    {% if evidence.id_physiography %}<div class="detail-item"><strong><i class="fas fa-water"></i> Physiography</strong> {{ evidence.id_physiography }}</div>{% endif %}
                    {% if evidence.additional_topography %}<div class="detail-item"><strong><i class="fas fa-map-signs"></i> Additional Topography</strong> {{ evidence.additional_topography|linebreaksbr }}</div>{% endif %}
                </div>
            </div>

            <!-- Research History Tab -->
            <div id="research" class="tab-content">
                <div class="detail-row">
                    {% if evidence.id_first_discovery_method %}<div class="detail-item"><strong><i class="fas fa-compass"></i> First Discovery Method</strong> {{ evidence.id_first_discovery_method }}</div>{% endif %}
                </div>
                {% if evidence.id_investigation %}
                    <div class="detail-row mt-2">
                        {% if evidence.id_investigation.project_name %}<div class="detail-item"><strong><i class="fas fa-project-diagram"></i> Project Name</strong> {{ evidence.id_investigation.project_name }}</div>{% endif %}
                        {% if evidence.id_investigation.id_investigation_type %}<div class="detail-item"><strong><i class="fas fa-search"></i> Investigation Type</strong> {{ evidence.id_investigation.id_investigation_type }}</div>{% endif %}
                        {% if evidence.id_investigation.period %}<div class="detail-item"><strong><i class="fas fa-calendar"></i> Period</strong> {{ evidence.id_investigation.period }}</div>{% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Documentation Tab -->
            <div id="docs" class="tab-content">
                <!-- Bibliographies Section -->
                {% if arch_ev_bibliographies %}
                    <h6 class="mb-3"><i class="fas fa-book"></i> Bibliografia ({{ arch_ev_bibliographies|length }})</h6>
                    {% for biblio in arch_ev_bibliographies %}
                        <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('biblio-{{ forloop.counter }}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-book-open"></i> {{ biblio.title|default:"Untitled" }}</strong>
                                <i class="fas fa-chevron-down" id="biblio-{{ forloop.counter }}-icon"></i>
                            </div>
                            <div class="text-muted small mt-1">{{ biblio.author|default:"â€”" }}{% if biblio.year %} ({{ biblio.year }}){% endif %}</div>
                            <div id="biblio-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                                <div class="row">
                                    {% if biblio.title %}<div class="col-md-6"><strong>Titolo:</strong> {{ biblio.title }}</div>{% endif %}
                                    {% if biblio.author %}<div class="col-md-6"><strong>Autore:</strong> {{ biblio.author }}</div>{% endif %}
                                    {% if biblio.year %}<div class="col-md-4"><strong>Anno:</strong> {{ biblio.year }}</div>{% endif %}
                                    {% if biblio.doi %}<div class="col-md-4"><strong>DOI:</strong> {{ biblio.doi }}</div>{% endif %}
                                    {% if biblio.tipo %}<div class="col-md-4"><strong>Tipo:</strong> {{ biblio.tipo }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <hr class="my-3">
                {% endif %}

                <!-- Sources Section -->
                {% if arch_ev_sources_list %}
                    <h6 class="mb-3"><i class="fas fa-file-alt"></i> Fonti ({{ arch_ev_sources_list|length }})</h6>
                    {% for source in arch_ev_sources_list %}
                        <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('source-{{ forloop.counter }}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-scroll"></i> {{ source.name|default:"Unnamed Source" }}</strong>
                                <i class="fas fa-chevron-down" id="source-{{ forloop.counter }}-icon"></i>
                            </div>
                            {% if source.id_chronology %}<div class="text-muted small mt-1">{{ source.id_chronology }}</div>{% endif %}
                            <div id="source-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                                <div class="row">
                                    {% if source.name %}<div class="col-md-6"><strong>Nome:</strong> {{ source.name }}</div>{% endif %}
                                    {% if source.id_chronology %}<div class="col-md-6"><strong>Cronologia:</strong> {{ source.id_chronology }}</div>{% endif %}
                                    {% if source.id_sources_type %}<div class="col-md-6"><strong>Tipo:</strong> {{ source.id_sources_type }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <hr class="my-3">
                {% endif %}

                <!-- Related Documentation Section -->
                {% if arch_ev_related_docs %}
                    <h6 class="mb-3"><i class="fas fa-paperclip"></i> Altra documentazione ({{ arch_ev_related_docs|length }})</h6>
                    {% for doc in arch_ev_related_docs %}
                        <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('doc-{{ forloop.counter }}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-file"></i> {{ doc.name|default:"Unnamed Document" }}</strong>
                                <i class="fas fa-chevron-down" id="doc-{{ forloop.counter }}-icon"></i>
                            </div>
                            {% if doc.author or doc.year %}<div class="text-muted small mt-1">{{ doc.author }}{% if doc.year %} ({{ doc.year }}){% endif %}</div>{% endif %}
                            <div id="doc-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                                <div class="row">
                                    {% if doc.name %}<div class="col-md-6"><strong>Nome:</strong> {{ doc.name }}</div>{% endif %}
                                    {% if doc.author %}<div class="col-md-6"><strong>Autore:</strong> {{ doc.author }}</div>{% endif %}
                                    {% if doc.year %}<div class="col-md-4"><strong>Anno:</strong> {{ doc.year }}</div>{% endif %}
                                    {% if doc.type %}<div class="col-md-4"><strong>Tipo:</strong> {{ doc.type }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <hr class="my-3">
                {% endif %}

                <!-- Images Section -->
                {% if evidence_images %}
                    <h6 class="mb-3"><i class="fas fa-image"></i> Immagini ({{ evidence_images|length }})</h6>
                    {% for image in evidence_images %}
                        <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('image-{{ forloop.counter }}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-camera"></i> {{ image.desc_image|default:"Image #"|add:image.id }}</strong>
                                <i class="fas fa-chevron-down" id="image-{{ forloop.counter }}-icon"></i>
                            </div>
                            <div class="text-muted small mt-1">
                                {% if image.id_image_type %}{{ image.id_image_type }}{% endif %}
                                {% if image.author %} - {{ image.author }}{% endif %}
                            </div>
                            <div id="image-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        {% if image.source_url %}
                                            <img src="{{ image.source_url }}" alt="{{ image.desc_image|default:'Image' }}" class="img-fluid rounded" style="max-height: 200px; width: 100%; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;">
                                                <i class="fas fa-image fa-3x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-8">
                                        <div class="row">
                                            {% if image.desc_image %}<div class="col-md-12"><strong>Descrizione:</strong> {{ image.desc_image }}</div>{% endif %}
                                            {% if image.id_image_type %}<div class="col-md-6 mt-2"><strong>Tipo:</strong> {{ image.id_image_type }}</div>{% endif %}
                                            {% if image.id_image_scale %}<div class="col-md-6 mt-2"><strong>Scala:</strong> {{ image.id_image_scale }}</div>{% endif %}
                                            {% if image.author %}<div class="col-md-6 mt-2"><strong>Autore:</strong> {{ image.author }}</div>{% endif %}
                                            {% if image.source_url %}
                                                <div class="col-md-12 mt-2">
                                                    <a href="{{ image.source_url }}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">
                                                        <i class="fas fa-external-link-alt"></i> Visualizza immagine
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Notes Tab -->
            <div id="notes" class="tab-content">
                <div class="detail-row">
                    {% if evidence.notes %}
                        <div class="detail-item">
                            <strong><i class="fas fa-sticky-note"></i> Notes</strong>
                            <div class="mt-2">{{ evidence.notes|linebreaksbr }}</div>
                        </div>
                    {% else %}
                        <div class="detail-item text-muted">
                            <strong><i class="fas fa-sticky-note"></i> Notes</strong>
                            <div class="mt-2">No notes recorded.</div>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>

<script>
function toggleDetails(id) {
    const content = document.getElementById(id);
    const icon = document.getElementById(id + '-icon');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
}

function initLeafletMap(divId) {
    const el = document.getElementById(divId);
    if (!el) return;
    if (el._leaflet_map) {
        setTimeout(() => el._leaflet_map.invalidateSize(true), 50);
        return;
    }
    const lat = parseFloat(el.dataset.lat);
    const lon = parseFloat(el.dataset.lon);
    if (isNaN(lat) || isNaN(lon)) return;
    const map = L.map(divId);
    el._leaflet_map = map;
    const marker = L.marker([lat, lon]).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.setView([lat, lon], 13);
    setTimeout(() => map.invalidateSize(true), 50);
}

function showTab(evt, tabName) {
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tc => tc.classList.remove('active'));
  
    const tabButtons = document.querySelectorAll('.detail-tab');
    tabButtons.forEach(tb => tb.classList.remove('active'));
  
    const tab = document.getElementById(tabName);
    tab.classList.add('active');
    evt.currentTarget.classList.add('active');

    if (tabName === 'pos') {
        initLeafletMap('evidence-map');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const posTab = document.getElementById('pos');
    if (posTab && posTab.classList.contains('active')) {
        initLeafletMap('evidence-map');
    }
});
</script>
{% endblock %}
{% extends "frontend/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'frontend/database_browser.css' %}">

<style>
  /* Simple modal styling for backup confirmation */
  .modal-backdrop-custom {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  }
  .modal-card {
    background: #fff;
    border-radius: 8px;
    padding: 24px;
    max-width: 520px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  .modal-card h3 { margin-top: 0; }
  .modal-card .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }
  .modal-warning { color: #b94a48; font-weight: 600; }
</style>

<div class="database-browser-container">
  <!-- Header -->
  <div class="db-header">
    <div class="db-header-content">
      <div class="db-title">
        <i class="fas fa-database"></i>
        <div>
          <h1>Database Browser</h1>
          <p>Staff-only access to view all database tables and their content</p>
        </div>
      </div>
      <div class="db-stats">
        <div class="stat-card">
          <i class="fas fa-table"></i>
          <div>
            <span class="stat-value">{{ tables|length }}</span>
            <span class="stat-label">Tables</span>
          </div>
        </div>
        {% if selected_table %}
        <div class="stat-card">
          <i class="fas fa-list"></i>
          <div>
            <span class="stat-value">{{ total_rows }}</span>
            <span class="stat-label">Rows</span>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="db-content">
    <!-- Sidebar -->
    <div class="db-sidebar">
      <div class="sidebar-header">
        <i class="fas fa-list"></i>
        <h3>Tables</h3>
        <span class="sidebar-count">{{ tables|length }}</span>
      </div>
      
      <div class="sidebar-search">
        <i class="fas fa-search"></i>
        <input type="text" id="tableSearch" placeholder="Search tables..." class="table-search-input">
      </div>

      <div class="sidebar-list">
        {% for table in tables %}
          <a href="?table={{ table }}&page=1" 
             class="table-item {% if selected_table == table %}active{% endif %}"
             data-table-name="{{ table }}">
            <i class="fas fa-table"></i>
            <span class="table-name">{{ table }}</span>
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- Main Panel -->
    <div class="db-main">
      {% if selected_table %}
        <!-- Table Header -->
        <div class="table-panel-header">
          <div class="table-title">
            <i class="fas fa-table"></i>
            <h2>{{ selected_table }}</h2>
            <span class="table-row-count">{{ total_rows }} rows</span>
          </div>
        </div>

        {% if table_data %}
          <!-- Column Information -->
          <div class="columns-section">
            <div class="columns-header">
              <h4><i class="fas fa-columns"></i> Schema</h4>
              <span class="columns-count">{{ columns|length }} columns</span>
            </div>
            <div class="columns-grid">
              {% for col_name, col_type in columns %}
                <div class="column-badge">
                  <span class="column-name">{{ col_name }}</span>
                  <span class="column-type">{{ col_type }}</span>
                </div>
              {% endfor %}
            </div>
          </div>

          <!-- Data Table -->
          <div class="data-section">
            <div class="data-header">
              <h4><i class="fas fa-th"></i> Data</h4>
              <span class="page-info">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
              </span>
            </div>

            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    {% for col_name in col_names %}
                      <th>
                        <span class="column-header-text">{{ col_name }}</span>
                      </th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in table_data %}
                    <tr class="data-row">
                      {% for cell in row %}
                        <td>
                          {% if cell.is_fk %}
                            {# Foreign key column with related data #}
                            {% if cell.value is None %}
                              <span class="cell-null">NULL</span>
                            {% else %}
                              <div class="cell-fk">
                                <span class="fk-id">{{ cell.value }}</span>
                                {% if cell.display %}
                                  <span class="fk-display">{{ cell.display }}</span>
                                  <span class="fk-table">{{ cell.fk_table }}</span>
                                {% else %}
                                  <span class="fk-missing">
                                    <i class="fas fa-exclamation-triangle"></i> Not found
                                  </span>
                                  <span class="fk-table">{{ cell.fk_table }}</span>
                                {% endif %}
                              </div>
                            {% endif %}
                          {% else %}
                            {# Regular column #}
                            {% if cell.value %}
                              {% if cell.value|stringformat:"s"|length > 100 %}
                                <span class="cell-text" title="{{ cell.value }}">
                                  {{ cell.value|stringformat:"s"|truncatechars:100 }}
                                </span>
                              {% else %}
                                <span class="cell-text">{{ cell.value }}</span>
                              {% endif %}
                            {% else %}
                              <span class="cell-empty">-</span>
                            {% endif %}
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
              <div class="pagination-section">
                <nav aria-label="Table pagination" class="pagination-nav">
                  {% if page_obj.has_previous %}
                    <a href="?table={{ selected_table }}&page=1" class="pagination-btn pagination-first" title="First page">
                      <i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>
                    </a>
                    <a href="?table={{ selected_table }}&page={{ page_obj.previous_page_number }}" class="pagination-btn pagination-prev" title="Previous page">
                      <i class="fas fa-chevron-left"></i>
                    </a>
                  {% else %}
                    <span class="pagination-btn pagination-disabled"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></span>
                    <span class="pagination-btn pagination-disabled"><i class="fas fa-chevron-left"></i></span>
                  {% endif %}

                  <span class="pagination-info">
                    {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_rows }}
                  </span>

                  {% if page_obj.has_next %}
                    <a href="?table={{ selected_table }}&page={{ page_obj.next_page_number }}" class="pagination-btn pagination-next" title="Next page">
                      <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="?table={{ selected_table }}&page={{ page_obj.paginator.num_pages }}" class="pagination-btn pagination-last" title="Last page">
                      <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
                    </a>
                  {% else %}
                    <span class="pagination-btn pagination-disabled"><i class="fas fa-chevron-right"></i></span>
                    <span class="pagination-btn pagination-disabled"><i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></span>
                  {% endif %}
                </nav>
              </div>
            {% endif %}
          </div>

        {% else %}
          <div class="empty-state">
            <i class="fas fa-inbox fa-3x"></i>
            <h4>No data found</h4>
            <p>This table is empty or could not be read</p>
          </div>
        {% endif %}

      {% else %}
        <div class="welcome-state">
          <div class="welcome-icon">
            <i class="fas fa-database"></i>
          </div>
          <h3>Welcome to Database Browser</h3>
          <p>Select a table from the list to view its contents and schema information</p>
          <div class="welcome-info">
            <div class="info-card">
              <i class="fas fa-layer-group"></i>
              <h5>{{ tables|length }} Tables Available</h5>
            </div>
            <div class="info-card">
              <i class="fas fa-lock"></i>
              <h5>Admin Only Access</h5>
            </div>
            <div class="info-card">
              <i class="fas fa-link"></i>
              <h5>View Relations</h5>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Action Buttons (Export/Import) -->
  <div class="db-actions" style="display: flex; justify-content: flex-end; align-items: center; gap: 1em; margin-top: 1em; margin-bottom: 1em;">
    <form method="get" action="{% url 'export_database' %}">
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-download"></i> Export Database
      </button>
    </form>
    <form id="import-form" method="post" action="{% url 'import_database' %}" enctype="multipart/form-data" style="display:inline;">
      {% csrf_token %}
      <label class="btn btn-primary" style="margin-left: 0.5em;">
        <i class="fas fa-upload"></i> Import Backup
        <input type="file" name="backup_file" accept=".dump,.sql,.gz" style="display:none;" onchange="handleImportFileChange(event);">
      </label>
    </form>
  </div>

  <!-- Custom confirmation modal for import -->
  <div class="modal-backdrop-custom" id="import-modal">
    <div class="modal-card">
      <h3><i class="fas fa-exclamation-triangle" style="color:#d9534f;"></i> Confirm Backup Import</h3>
      <p id="import-file-name" style="font-weight:600;"></p>
      <p class="modal-warning">This will overwrite the current database. All data added after the backup was created will be lost.</p>
      <p class="modal-warning">This action is irreversible. Continue only if you have a recent backup.</p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="import-cancel-btn">Cancel</button>
        <button type="button" class="btn btn-danger" id="import-confirm-btn">Yes, Import</button>
      </div>
    </div>
  </div>
    <script>
      // Modal-based confirmation for import
      let pendingImportInput = null;
      function handleImportFileChange(e) {
        if (!e.target.files || !e.target.files.length) return;
        pendingImportInput = e.target;
        const fileName = e.target.files[0].name;
        document.getElementById('import-file-name').innerText = `Backup: ${fileName}`;
        document.getElementById('import-modal').style.display = 'flex';
      }
      document.getElementById('import-cancel-btn').addEventListener('click', function() {
        if (pendingImportInput) pendingImportInput.value = '';
        pendingImportInput = null;
        document.getElementById('import-modal').style.display = 'none';
      });
      document.getElementById('import-confirm-btn').addEventListener('click', function() {
        if (pendingImportInput) {
          document.getElementById('import-modal').style.display = 'none';
          document.getElementById('import-form').submit();
        }
      });

      // Table search functionality
      document.getElementById('tableSearch').addEventListener('keyup', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const tableItems = document.querySelectorAll('.table-item');
        tableItems.forEach(item => {
          const tableName = item.dataset.tableName.toLowerCase();
          item.style.display = tableName.includes(searchTerm) ? '' : 'none';
        });
      });
    </script>
  <div class="alert alert-warning" style="margin-top: 1em;">
    <b>Warning:</b> Importing a backup will <u>overwrite all current data</u> and <u>all changes since the backup will be lost</u>.
  </div>
  <div class="alert alert-danger" style="margin-top: 0.5em;">
    <b>Are you sure?</b> This action is <u>irreversible</u> and will delete all data added after the backup was created.
  </div>
</div>

<script>
  // Table search functionality
  document.getElementById('tableSearch').addEventListener('keyup', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const tableItems = document.querySelectorAll('.table-item');
    
    tableItems.forEach(item => {
      const tableName = item.dataset.tableName.toLowerCase();
      if (tableName.includes(searchTerm)) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });
  });
</script>
{% endblock content %}


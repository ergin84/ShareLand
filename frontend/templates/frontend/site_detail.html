{% extends "frontend/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'frontend/public_research.css' %}">

<style>
  .detail-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0; }
  .detail-tab { flex: 1; min-width: 100px; padding: 0.75rem; background: #f8f9fa; border: none; border-radius: 8px 8px 0 0; cursor: pointer; transition: all 0.3s; font-weight: 500; color: #6c757d; font-size: 0.9rem; }
  .detail-tab:hover { background: #e9ecef; }
  .detail-tab.active { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(44, 62, 80, 0.3); }
  .tab-content { display: none; animation: fadeIn 0.3s; }
  .tab-content.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<div class="container mt-4 mb-4">
  <div class="research-card mb-4">
    <div class="research-card-header d-flex justify-content-between align-items-start flex-wrap">
      <div>
        <h2 class="mb-1"><i class="fas fa-landmark"></i> {{ site.site_name|default:"Site #"|add:site.id }}</h2>
        {% if site.locality_name %}
          <div class="text-muted">{{ site.locality_name }}</div>
        {% endif %}
      </div>
      {% if user.is_authenticated %}
        <div class="btn-group">
          <a href="{% url 'site_update' site.id %}" class="btn btn-warning-modern btn-modern btn-sm"><i class="fas fa-edit"></i> Update</a>
          <a href="{% url 'site_delete' site.id %}" class="btn btn-danger-modern btn-modern btn-sm"><i class="fas fa-trash"></i> Delete</a>
        </div>
      {% endif %}
    </div>

    <!-- Manage Relations Section -->
    {% if user.is_authenticated %}
    <div class="mt-3 p-3" style="background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
      <h5 class="mb-3"><i class="fas fa-link"></i> Manage Relations</h5>
      <div class="row">
        <div class="col-md-6 mb-2">
          <a href="{% url 'evidence_create' %}?site_id={{ site.id }}" class="btn btn-block" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; border: none; padding: 12px; border-radius: 8px; transition: all 0.3s;">
            <i class="fas fa-plus-circle"></i> Create Evidence
            <small class="d-block mt-1" style="font-size: 0.85em; opacity: 0.9;">Create new evidence</small>
          </a>
        </div>
        <div class="col-md-6 mb-2">
          <button type="button" class="btn btn-block" data-toggle="modal" data-target="#addSiteEvidenceModal" style="background: white; color: #28a745; border: 2px solid #28a745; padding: 12px; border-radius: 8px; transition: all 0.3s;">
            <i class="fas fa-link"></i> Link Evidence
            <small class="d-block mt-1" style="font-size: 0.85em;">Link existing evidence</small>
          </button>
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Tabs Navigation -->
    <div class="detail-tabs">
      <button class="detail-tab active" onclick="showTab(event, 'general')"><i class="fas fa-info-circle"></i> General</button>
      <button class="detail-tab" onclick="showTab(event, 'positioning')"><i class="fas fa-map-pin"></i> Positioning</button>
      <button class="detail-tab" onclick="showTab(event, 'landscape')"><i class="fas fa-mountain"></i> Landscape</button>
      <button class="detail-tab" onclick="showTab(event, 'interpretation')"><i class="fas fa-lightbulb"></i> Interpretation</button>
      <button class="detail-tab" onclick="showTab(event, 'research')"><i class="fas fa-book"></i> Research</button>
      <button class="detail-tab" onclick="showTab(event, 'documentation')"><i class="fas fa-file-alt"></i> Documentation</button>
      <button class="detail-tab" onclick="showTab(event, 'notes')"><i class="fas fa-sticky-note"></i> Notes</button>
    </div>
    
    <div class="research-card-body">
      
      <!-- General Tab -->
      <div id="general" class="tab-content active">
        <div class="detail-row">
          {% if site.id_country %}<div class="detail-item"><strong><i class="fas fa-flag"></i> Country</strong> {{ site.id_country }}</div>{% endif %}
          {% if site.id_region %}<div class="detail-item"><strong><i class="fas fa-map"></i> Region</strong> {{ site.id_region }}</div>{% endif %}
          {% if site.id_province %}<div class="detail-item"><strong><i class="fas fa-map-marked-alt"></i> Province</strong> {{ site.id_province }}</div>{% endif %}
          {% if site.id_municipality %}<div class="detail-item"><strong><i class="fas fa-city"></i> Municipality</strong> {{ site.id_municipality }}</div>{% endif %}
        </div>
        <div class="detail-row mt-2">
          {% if site.description %}
            <div class="detail-item">
              <strong><i class="fas fa-align-left"></i> Description</strong>
              <div class="mt-2">{{ site.description|linebreaksbr }}</div>
            </div>
          {% else %}
            <div class="detail-item text-muted">
              <strong><i class="fas fa-align-left"></i> Description</strong>
              <div class="mt-2">No description recorded.</div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Positioning Tab -->
      <div id="positioning" class="tab-content">
        <div class="detail-row">
          {% if site.lat and site.lon %}<div class="detail-item"><strong><i class="fas fa-globe"></i> Coordinates</strong> {{ site.lat }}, {{ site.lon }}</div>{% endif %}
          {% if site.elevation %}<div class="detail-item"><strong><i class="fas fa-mountain"></i> Elevation</strong> {{ site.elevation }} m</div>{% endif %}
        </div>
        {% if site.lat and site.lon %}
        <div class="mt-3">
          <h6><i class="fas fa-map"></i> Location Map</h6>
          <div id="site-map" data-lat="{{ site.lat }}" data-lon="{{ site.lon }}" style="height: 300px; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0;"></div>
        </div>
        {% endif %}
      </div>

      <!-- Landscape Tab -->
      <div id="landscape" class="tab-content">
        <div class="detail-row">
          {% if site.site_environment_relationship %}
            <div class="detail-item">
              <strong><i class="fas fa-tree"></i> Environment Relationship</strong>
              <div class="mt-2">{{ site.site_environment_relationship|linebreaksbr }}</div>
            </div>
          {% else %}
            <div class="detail-item text-muted">
              <strong><i class="fas fa-tree"></i> Environment Relationship</strong>
              <div class="mt-2">No landscape information recorded.</div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Interpretation Tab -->
      <div id="interpretation" class="tab-content">
        {% if interpretation %}
          <div class="detail-row">
            {% if interpretation.id_functional_class %}<div class="detail-item"><strong>Functional Class</strong> {{ interpretation.id_functional_class }}</div>{% endif %}
            {% if interpretation.id_typology %}<div class="detail-item"><strong>Typology</strong> {{ interpretation.id_typology }}</div>{% endif %}
            {% if interpretation.id_typology_detail %}<div class="detail-item"><strong>Typology Detail</strong> {{ interpretation.id_typology_detail }}</div>{% endif %}
            {% if interpretation.id_chronology %}<div class="detail-item"><strong>Chronology</strong> {{ interpretation.id_chronology }}</div>{% endif %}
          </div>
          {% if site_toponymy %}
            <hr>
            <h6><i class="fas fa-history"></i> Toponymy</h6>
            <div class="detail-row">
              <div class="detail-item"><strong>Ancient name</strong> {{ site_toponymy.ancient_place_name|default:"—" }}</div>
              <div class="detail-item"><strong>Contemporary name</strong> {{ site_toponymy.contemporary_place_name|default:"—" }}</div>
            </div>
          {% endif %}
        {% else %}
          <p class="text-muted">No interpretation data recorded.</p>
        {% endif %}
      </div>

      <!-- Research Tab -->
      <div id="research" class="tab-content">
        {% if site_researches %}
          <ul class="list-group list-group-flush">
            {% for research in site_researches %}
              <li class="list-group-item"><a href="{% url 'public-research-detail' research.id %}" class="text-decoration-none">{{ research.title|default:"Research #"|add:research.id }}</a></li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No research linked to this site.</p>
        {% endif %}
      </div>

      <!-- Documentation Tab -->
      <div id="documentation" class="tab-content">
        <!-- Investigation Section -->
        {% if site_investigation and site_investigation.id_investigation %}
          <h6 class="mb-3"><i class="fas fa-flask"></i> Investigazione</h6>
          <div class="detail-row mb-3">
            {% if site_investigation.id_investigation.project_name %}<div class="detail-item"><strong><i class="fas fa-project-diagram"></i> Project</strong> {{ site_investigation.id_investigation.project_name }}</div>{% endif %}
            {% if site_investigation.id_investigation.period %}<div class="detail-item"><strong><i class="fas fa-calendar"></i> Period</strong> {{ site_investigation.id_investigation.period }}</div>{% endif %}
            {% if site_investigation.id_investigation.id_investigation_type %}<div class="detail-item"><strong><i class="fas fa-search"></i> Type</strong> {{ site_investigation.id_investigation.id_investigation_type }}</div>{% endif %}
          </div>
          <hr class="my-3">
        {% endif %}

        <!-- Bibliographies Section -->
        {% if site_bibliographies %}
          <h6 class="mb-3"><i class="fas fa-book"></i> Bibliografia ({{ site_bibliographies|length }})</h6>
          {% for biblio in site_bibliographies %}
            <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('site-biblio-{{ forloop.counter }}')">
              <div class="d-flex justify-content-between align-items-center">
                <strong><i class="fas fa-book-open"></i> {{ biblio.title|default:"Untitled" }}</strong>
                <i class="fas fa-chevron-down" id="site-biblio-{{ forloop.counter }}-icon"></i>
              </div>
              <div class="text-muted small mt-1">{{ biblio.author|default:"—" }}{% if biblio.year %} ({{ biblio.year }}){% endif %}</div>
              <div id="site-biblio-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                <div class="row">
                  {% if biblio.title %}<div class="col-md-6"><strong>Titolo:</strong> {{ biblio.title }}</div>{% endif %}
                  {% if biblio.author %}<div class="col-md-6"><strong>Autore:</strong> {{ biblio.author }}</div>{% endif %}
                  {% if biblio.year %}<div class="col-md-4"><strong>Anno:</strong> {{ biblio.year }}</div>{% endif %}
                  {% if biblio.doi %}<div class="col-md-4"><strong>DOI:</strong> {{ biblio.doi }}</div>{% endif %}
                  {% if biblio.tipo %}<div class="col-md-4"><strong>Tipo:</strong> {{ biblio.tipo }}</div>{% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
          <hr class="my-3">
        {% endif %}

        <!-- Sources Section -->
        {% if site_sources %}
          <h6 class="mb-3"><i class="fas fa-file-alt"></i> Fonti ({{ site_sources|length }})</h6>
          {% for source in site_sources %}
            <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('site-source-{{ forloop.counter }}')">
              <div class="d-flex justify-content-between align-items-center">
                <strong><i class="fas fa-scroll"></i> {{ source.name|default:"Unnamed Source" }}</strong>
                <i class="fas fa-chevron-down" id="site-source-{{ forloop.counter }}-icon"></i>
              </div>
              {% if source.id_chronology %}<div class="text-muted small mt-1">{{ source.id_chronology }}</div>{% endif %}
              <div id="site-source-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                <div class="row">
                  {% if source.name %}<div class="col-md-6"><strong>Nome:</strong> {{ source.name }}</div>{% endif %}
                  {% if source.id_chronology %}<div class="col-md-6"><strong>Cronologia:</strong> {{ source.id_chronology }}</div>{% endif %}
                  {% if source.id_sources_type %}<div class="col-md-6"><strong>Tipo:</strong> {{ source.id_sources_type }}</div>{% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
          <hr class="my-3">
        {% endif %}

        <!-- Related Documentation Section -->
        {% if site_docs %}
          <h6 class="mb-3"><i class="fas fa-paperclip"></i> Altra documentazione ({{ site_docs|length }})</h6>
          {% for doc in site_docs %}
            <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('site-doc-{{ forloop.counter }}')">
              <div class="d-flex justify-content-between align-items-center">
                <strong><i class="fas fa-file"></i> {{ doc.name|default:"Unnamed Document" }}</strong>
                <i class="fas fa-chevron-down" id="site-doc-{{ forloop.counter }}-icon"></i>
              </div>
              {% if doc.author or doc.year %}<div class="text-muted small mt-1">{{ doc.author }}{% if doc.year %} ({{ doc.year }}){% endif %}</div>{% endif %}
              <div id="site-doc-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                <div class="row">
                  {% if doc.name %}<div class="col-md-6"><strong>Nome:</strong> {{ doc.name }}</div>{% endif %}
                  {% if doc.author %}<div class="col-md-6"><strong>Autore:</strong> {{ doc.author }}</div>{% endif %}
                  {% if doc.year %}<div class="col-md-4"><strong>Anno:</strong> {{ doc.year }}</div>{% endif %}
                  {% if doc.type %}<div class="col-md-4"><strong>Tipo:</strong> {{ doc.type }}</div>{% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
          <hr class="my-3">
        {% endif %}

        <!-- Images Section -->
        {% if site_images %}
          <h6 class="mb-3"><i class="fas fa-image"></i> Immagini ({{ site_images|length }})</h6>
          {% for image in site_images %}
            <div class="detail-item mb-2" style="cursor: pointer;" onclick="toggleDetails('site-image-{{ forloop.counter }}')">
              <div class="d-flex justify-content-between align-items-center">
                <strong><i class="fas fa-camera"></i> {{ image.desc_image|default:"Image #"|add:image.id }}</strong>
                <i class="fas fa-chevron-down" id="site-image-{{ forloop.counter }}-icon"></i>
              </div>
              <div class="text-muted small mt-1">
                {% if image.id_image_type %}{{ image.id_image_type }}{% endif %}
                {% if image.author %} - {{ image.author }}{% endif %}
              </div>
              <div id="site-image-{{ forloop.counter }}" class="detail-content mt-2" style="display: none;">
                <div class="row align-items-center">
                  <div class="col-md-4">
                    {% if image.source_url %}
                      <img src="{{ image.source_url }}" alt="{{ image.desc_image|default:'Image' }}" class="img-fluid rounded" style="max-height: 200px; width: 100%; object-fit: cover;">
                    {% else %}
                      <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="fas fa-image fa-3x text-muted"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div class="col-md-8">
                    <div class="row">
                      {% if image.desc_image %}<div class="col-md-12"><strong>Descrizione:</strong> {{ image.desc_image }}</div>{% endif %}
                      {% if image.id_image_type %}<div class="col-md-6 mt-2"><strong>Tipo:</strong> {{ image.id_image_type }}</div>{% endif %}
                      {% if image.id_image_scale %}<div class="col-md-6 mt-2"><strong>Scala:</strong> {{ image.id_image_scale }}</div>{% endif %}
                      {% if image.author %}<div class="col-md-6 mt-2"><strong>Autore:</strong> {{ image.author }}</div>{% endif %}
                      {% if image.source_url %}
                        <div class="col-md-12 mt-2">
                          <a href="{{ image.source_url }}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">
                            <i class="fas fa-external-link-alt"></i> Visualizza immagine
                          </a>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>

      <!-- Notes Tab -->
      <div id="notes" class="tab-content">
        <div class="detail-row">
          {% if site.notes %}
            <div class="detail-item">
              <strong><i class="fas fa-sticky-note"></i> Notes</strong>
              <div class="mt-2">{{ site.notes|linebreaksbr }}</div>
            </div>
          {% else %}
            <div class="detail-item text-muted">
              <strong><i class="fas fa-sticky-note"></i> Notes</strong>
              <div class="mt-2">No notes recorded.</div>
            </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>

  <div class="research-card mb-4">
    <div class="section-header d-flex justify-content-between align-items-center">
      <div>
        <i class="fas fa-shovel"></i> Archaeological Evidences ({{ site_evidences|length }})
      </div>
    </div>
    <div class="research-card-body">
      {% if site_evidences %}
        <ul class="list-group list-group-flush">
          {% for evidence in site_evidences %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <a href="{% url 'evidence_detail' evidence.id %}" class="text-decoration-none">
                  {% if evidence.evidence_name %}{{ evidence.evidence_name }}{% elif evidence.description %}{{ evidence.description|truncatewords:12 }}{% else %}Evidence #{{ evidence.id }}{% endif %}
                </a>
                {% if evidence.description %}
                  <div class="text-muted small">{{ evidence.description|truncatewords:18 }}</div>
                {% endif %}
              </div>
              {% if user.is_authenticated %}
                <span class="btn-group">
                  <a href="{% url 'evidence_update' evidence.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                  <a href="{% url 'evidence_delete' evidence.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
                </span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No evidence linked to this site yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Modal for Adding Related Evidence -->
  <div class="modal fade" id="addSiteEvidenceModal" tabindex="-1" role="dialog" aria-labelledby="addSiteEvidenceModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="addSiteEvidenceModalLabel">
                      <i class="fas fa-link"></i> Link Existing Archaeological Evidence
                  </h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body">
                  <div class="form-group">
                      <label for="evidenceSelect"><strong>Select Archaeological Evidence</strong></label>
                      <select class="form-control" id="evidenceSelect">
                          <option value="">-- Choose evidence --</option>
                      </select>
                      <small class="form-text text-muted">Select archaeological evidence to link to this site</small>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary-modern btn-modern" onclick="addSiteEvidenceRelation()">
                      <i class="fas fa-save"></i> Save Relation
                  </button>
              </div>
          </div>
      </div>
  </div>
</div>

<script>
function toggleDetails(id) {
  const content = document.getElementById(id);
  const icon = document.getElementById(id + '-icon');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-up');
  } else {
    content.style.display = 'none';
    icon.classList.remove('fa-chevron-up');
    icon.classList.add('fa-chevron-down');
  }
}

function initLeafletMap(divId) {
  const el = document.getElementById(divId);
  if (!el) return;
  // If already initialized, just invalidate size
  if (el._leaflet_map) {
    setTimeout(() => el._leaflet_map.invalidateSize(true), 50);
    return;
  }
  const lat = parseFloat(el.dataset.lat);
  const lon = parseFloat(el.dataset.lon);
  if (isNaN(lat) || isNaN(lon)) return;
  const map = L.map(divId);
  el._leaflet_map = map;
  const marker = L.marker([lat, lon]).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  map.setView([lat, lon], 13);
  setTimeout(() => map.invalidateSize(true), 50);
}

function showTab(evt, tabName) {
  const tabContents = document.querySelectorAll('.tab-content');
  tabContents.forEach(tc => tc.classList.remove('active'));
  
  const tabButtons = document.querySelectorAll('.detail-tab');
  tabButtons.forEach(tb => tb.classList.remove('active'));
  
  const tab = document.getElementById(tabName);
  tab.classList.add('active');
  evt.currentTarget.classList.add('active');

  // Initialize or fix map when Positioning tab becomes visible
  if (tabName === 'positioning') {
    initLeafletMap('site-map');
  }
}

// If Positioning is the default active tab, initialize on load
document.addEventListener('DOMContentLoaded', () => {
  const posTab = document.getElementById('positioning');
  if (posTab && posTab.classList.contains('active')) {
    initLeafletMap('site-map');
  }
  
  // TEST: Try loading data immediately on page load to verify functions work
  setTimeout(function() {
      console.log('=== TESTING: Direct call after 1 second ===');
      loadAvailableEvidence();
  }, 1000);
  
  // Load evidence when modal is opened
  const addEvidenceModal = document.getElementById('addSiteEvidenceModal');
  if (addEvidenceModal) {
      addEvidenceModal.addEventListener('show.bs.modal', function() {
          console.log('Evidence modal opened');
          loadAvailableEvidence();
      });
      // Also attach to modal shown event as fallback
      addEvidenceModal.addEventListener('shown.bs.modal', function() {
          console.log('Evidence modal shown (fallback)');
          if (!addEvidenceModal._evidenceLoaded) {
              loadAvailableEvidence();
          }
      });
      // Handle focus when modal closes - fix aria-hidden warning
      addEvidenceModal.addEventListener('hidden.bs.modal', function() {
          console.log('Evidence modal hidden - restoring focus');
          document.activeElement.blur();
      });
  }
});

function loadAvailableEvidence() {
    console.log('=== LOADING EVIDENCE ===');
    const evidenceSelect = document.getElementById('evidenceSelect');
    console.log('1. evidenceSelect element:', evidenceSelect);
    
    if (!evidenceSelect) {
        console.error('❌ evidenceSelect element not found');
        return;
    }
    
    console.log('2. evidenceSelect found - current options:', evidenceSelect.options.length);
    console.log('3. Fetching from: {% url "api-evidence-list" %}');
    
    fetch('{% url "api-evidence-list" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('4. Response received - Status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('5. Data received:', data);
        console.log('6. data.results:', data.results);
        console.log('7. Is array?', Array.isArray(data.results));
        console.log('8. Length:', data.results ? data.results.length : 'N/A');
        
        // Clear existing options (keep the placeholder)
        evidenceSelect.innerHTML = '<option value="">-- Choose evidence --</option>';
        console.log('9. Cleared dropdown, options count:', evidenceSelect.options.length);
        
        // Add evidence to dropdown
        if (data && data.results && Array.isArray(data.results) && data.results.length > 0) {
            console.log(`10. Adding ${data.results.length} evidence items...`);
            data.results.forEach((evidence, idx) => {
                const option = document.createElement('option');
                option.value = evidence.id;
                const displayName = evidence.evidence_name || `Evidence #${evidence.id}`;
                const description = evidence.description ? ` - ${evidence.description.substring(0, 40)}...` : '';
                option.textContent = displayName + description;
                evidenceSelect.appendChild(option);
                console.log(`   [${idx + 1}] Added: "${option.textContent}" (value: ${option.value})`);
            });
            console.log('11. Final options count:', evidenceSelect.options.length);
            console.log('✅ Evidence loaded successfully!');
            document.getElementById('addSiteEvidenceModal')._evidenceLoaded = true;
        } else {
            console.warn('❌ No evidence found in API response');
            evidenceSelect.innerHTML = '<option value="">-- No evidence available in database --</option>';
        }
    })
    .catch(error => {
        console.error('❌ Error loading evidence:', error);
        evidenceSelect.innerHTML = '<option value="">Error loading evidence</option>';
    });
}

function addSiteEvidenceRelation() {
    const evidenceSelect = document.getElementById('evidenceSelect');
    const evidenceId = evidenceSelect.value;
    const siteId = {{ site.id }};
    
    if (!evidenceId) {
        alert('Please select evidence');
        return;
    }
    
    fetch('{% url "api-site-evidence-create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            id_site: siteId,
            id_archaeological_evidence: evidenceId
        })
    })
    .then(response => {
        if (response.ok) {
            alert('Evidence linked successfully!');
            document.getElementById('addSiteEvidenceModal').querySelector('.close').click();
            // Reload page to show new relation
            location.reload();
        } else if (response.status === 400) {
            return response.json().then(data => {
                throw new Error(data.error || 'This relation already exists');
            });
        } else {
            throw new Error('Failed to create relation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
{% extends "frontend/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'frontend/public_research.css' %}">

<div class="container mt-4">
    <div class="public-research-container">
        <!-- Research Header -->
        <div class="research-card mb-4">
            <div class="research-card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <h2 class="mb-0">
                        <i class="fas fa-book-open"></i> {{ object.title|default:"Untitled Research" }}
                    </h2>
                    {% if user.is_authenticated %}
                        {% if user.is_staff or user == object.submitted_by %}
                            <div class="mt-2 mt-md-0">
                                <a href="{% url 'research-update' object.pk %}" class="btn btn-warning-modern btn-modern btn-sm">
                                    <i class="fas fa-edit"></i> Update
                                </a>
                                <a href="{% url 'research-delete' object.pk %}" class="btn btn-danger-modern btn-modern btn-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% if user.is_authenticated %}
                    {% if user.is_staff or user == object.submitted_by %}
                        <div class="mt-4 pt-3 border-top">
                            <div class="d-flex align-items-center mb-3">
                                <h6 class="mb-0"><i class="fas fa-link"></i> Manage Relations</h6>
                            </div>
                            <div class="row g-2">
                                <div class="col-12 col-sm-6 col-lg-3">
                                    <a href="{% url 'site_create' %}?research_id={{ object.id }}" class="btn btn-primary btn-modern w-100" style="text-align: left; background-color: #2c3e50; border-color: #2c3e50; color: #fff; font-weight: 500; padding: 12px;">
                                        <div style="color: #fff;"><i class="fas fa-plus"></i> <strong>Create Site</strong></div>
                                        <small class="d-block" style="color: #ecf0f1; margin-top: 4px;">Create a new site</small>
                                    </a>
                                </div>
                                <div class="col-12 col-sm-6 col-lg-3">
                                    <button type="button" class="btn btn-light w-100" style="text-align: left; border: 2px solid #27ae60; color: #27ae60; font-weight: 500; padding: 12px;" data-toggle="modal" data-target="#addResearchSiteModal">
                                        <div style="color: #27ae60;"><i class="fas fa-link"></i> <strong>Link Site</strong></div>
                                        <small class="d-block" style="color: #7f8c8d; margin-top: 4px;">Link existing site</small>
                                    </button>
                                </div>
                                <div class="col-12 col-sm-6 col-lg-3">
                                    <a href="{% url 'evidence_create' %}?research_id={{ object.id }}" class="btn btn-primary btn-modern w-100" style="text-align: left; background-color: #2c3e50; border-color: #2c3e50; color: #fff; font-weight: 500; padding: 12px;">
                                        <div style="color: #fff;"><i class="fas fa-plus"></i> <strong>Create Evidence</strong></div>
                                        <small class="d-block" style="color: #ecf0f1; margin-top: 4px;">Create new evidence</small>
                                    </a>
                                </div>
                                <div class="col-12 col-sm-6 col-lg-3">
                                    <button type="button" class="btn btn-light w-100" style="text-align: left; border: 2px solid #27ae60; color: #27ae60; font-weight: 500; padding: 12px;" data-toggle="modal" data-target="#addResearchEvidenceModal">
                                        <div style="color: #27ae60;"><i class="fas fa-link"></i> <strong>Link Evidence</strong></div>
                                        <small class="d-block" style="color: #7f8c8d; margin-top: 4px;">Link existing evidence</small>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            <div class="research-card-body">
                <div class="detail-row">
                    <div class="detail-item">
                        <strong><i class="fas fa-calendar-alt"></i> Year</strong>
                        {{ object.year|default:"N/A" }}
                    </div>
                    {% if object.type %}
                        <div class="detail-item">
                            <strong><i class="fas fa-tag"></i> Type</strong>
                            <span class="badge-modern">{{ object.type }}</span>
                        </div>
                    {% endif %}
                    {% if object.submitted_by %}
                        <div class="detail-item">
                            <strong><i class="fas fa-user"></i> Submitted by</strong>
                            <a href="{% url 'user-researches' object.submitted_by.username %}" class="text-decoration-none">
                                {{ object.submitted_by.profile.get_display_name }}
                            </a>
                        </div>
                    {% endif %}
                    {% if object.keywords %}
                        <div class="detail-item" style="flex: 1 1 100%;">
                            <strong><i class="fas fa-tags"></i> Keywords</strong>
                            {{ object.keywords }}
                        </div>
                    {% endif %}
                </div>
            
                <!-- Abstract and Map Section -->
                {% if object.abstract or map_html %}
                    <div class="row mt-4">
                        {% if object.abstract %}
                            <div class="{% if map_html %}col-md-6{% else %}col-12{% endif %} mb-3">
                                <div class="abstract-section">
                                    <h5 class="mb-3"><i class="fas fa-file-alt"></i> Abstract</h5>
                                    <p class="text-justify mb-0">{{ object.abstract }}</p>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if map_html %}
                            <div class="{% if object.abstract %}col-md-6{% else %}col-12{% endif %} mb-3">
                                <h5 class="mb-3"><i class="fas fa-map-marked-alt"></i> Research Area Map</h5>
                                <div class="map-container" style="width: 100%; height: {% if object.abstract %}400px{% else %}500px{% endif %};">
                                    {{ map_html|safe }}
                                </div>
                            </div>
                        {% elif object.geometry %}
                            <div class="{% if object.abstract %}col-md-6{% else %}col-12{% endif %} mb-3">
                                <h5 class="mb-3"><i class="fas fa-map"></i> Geometry</h5>
                                <p><small class="text-muted">{{ object.geometry|truncatewords:20 }}</small></p>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
                
                {% if authors %}
                    <div class="mt-4">
                        <h5 class="mb-3"><i class="fas fa-users"></i> Authors</h5>
                        <ul class="authors-list">
                            {% for author in authors %}
                                <li>
                                    <i class="fas fa-user-circle"></i>
                                    <strong>{{ author.first_name }} {{ author.last_name }}</strong>
                                    {% if author.profile.affiliation %} - <em>{{ author.profile.affiliation }}</em>{% endif %}
                                    {% if author.email %} <small class="text-muted">({{ author.email }})</small>{% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
        </div>
    </div>

        <!-- Sites Section -->
        {% if sites_with_details %}
            <div class="research-card mb-4">
                <div class="section-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-map-marker-alt"></i>
                        Related Sites <span class="badge badge-light ml-2">{{ sites_with_details|length }}</span>
                    </div>
                </div>
                <div class="research-card-body">
                    {% for site_data in sites_with_details %}
                        <div class="site-card">
                            <div class="site-card-header">
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <h4 class="mb-0">
                                        <i class="fas fa-landmark"></i> {{ site_data.site.site_name }}
                                    </h4>
                                    {% if user.is_authenticated %}
                                        {% if user.is_staff or user == research_owner %}
                                            <div class="mt-2 mt-md-0">
                                                <a href="{% url 'site_update' site_data.site.pk %}" class="btn btn-warning-modern btn-modern btn-sm">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                                <a href="{% url 'site_delete' site_data.site.pk %}" class="btn btn-danger-modern btn-modern btn-sm">
                                                    <i class="fas fa-trash"></i> Delete
                                                </a>
                                                <a href="{% url 'evidence_create' %}?site_id={{ site_data.site.pk }}" class="btn btn-primary-modern btn-modern btn-sm">
                                                    <i class="fas fa-plus"></i> Add Evidence
                                                </a>
                                                <button type="button" class="btn btn-success-modern btn-modern btn-sm" data-toggle="modal" data-target="#linkSiteEvidenceModal{{ site_data.site.pk }}">
                                                    <i class="fas fa-link"></i> Link Evidence
                                                </button>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="site-card-body">
                                <div class="detail-row">
                                    {% if site_data.site.locality_name %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-map-pin"></i> Locality</strong>
                                            {{ site_data.site.locality_name }}
                                        </div>
                                    {% endif %}
                                    {% if site_data.site.lat and site_data.site.lon %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-globe"></i> Coordinates</strong>
                                            {{ site_data.site.lat }}, {{ site_data.site.lon }}
                                        </div>
                                    {% endif %}
                                    {% if site_data.site.elevation %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-mountain"></i> Elevation</strong>
                                            {{ site_data.site.elevation }} m
                                        </div>
                                    {% endif %}
                                    {% if site_data.site.id_country %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-flag"></i> Country</strong>
                                            {{ site_data.site.id_country }}
                                        </div>
                                    {% endif %}
                                    {% if site_data.site.id_region %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-map"></i> Region</strong>
                                            {{ site_data.site.id_region }}
                                        </div>
                                    {% endif %}
                                    {% if site_data.site.id_province %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-map-marked-alt"></i> Province</strong>
                                            {{ site_data.site.id_province }}
                                        </div>
                                    {% endif %}
                                    {% if site_data.site.id_municipality %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-city"></i> Municipality</strong>
                                            {{ site_data.site.id_municipality }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                {% if site_data.site.description or site_data.site.notes or site_data.toponymy %}
                                    <div class="detail-row mt-3">
                                        {% if site_data.site.description %}
                                            <div class="detail-item" style="flex: 1 1 100%;">
                                                <strong><i class="fas fa-align-left"></i> Description</strong>
                                                {{ site_data.site.description }}
                                            </div>
                                        {% endif %}
                                        {% if site_data.site.notes %}
                                            <div class="detail-item" style="flex: 1 1 100%;">
                                                <strong><i class="fas fa-sticky-note"></i> Notes</strong>
                                                {{ site_data.site.notes }}
                                            </div>
                                        {% endif %}
                                        {% if site_data.toponymy %}
                                            <div class="detail-item">
                                                <strong><i class="fas fa-history"></i> Ancient Place Name</strong>
                                                {{ site_data.toponymy.ancient_place_name|default:"N/A" }}
                                            </div>
                                            <div class="detail-item">
                                                <strong><i class="fas fa-clock"></i> Contemporary Place Name</strong>
                                                {{ site_data.toponymy.contemporary_place_name|default:"N/A" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                <!-- Site Evidences -->
                                {% if site_data.evidences %}
                                    <hr class="my-3">
                                    <h6 class="mb-2"><i class="fas fa-shovel"></i> Archaeological Evidence at this Site ({{ site_data.evidences.count }})</h6>
                                    <ul class="list-group">
                                        {% for evidence in site_data.evidences %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <a href="{% url 'evidence_detail' evidence.id %}" class="text-decoration-none">
                                                    {% if evidence.evidence_name %}
                                                        {{ evidence.evidence_name }}
                                                    {% elif evidence.description %}
                                                        {{ evidence.description|truncatewords:12 }}
                                                    {% else %}
                                                        Evidence #{{ evidence.id }}
                                                    {% endif %}
                                                </a>
                                                {% if user.is_authenticated %}
                                                    {% if user.is_staff or user == research_owner %}
                                                        <span class="btn-group">
                                                            <a href="{% url 'evidence_update' evidence.id %}" class="btn btn-sm btn-outline-primary">Modifica</a>
                                                            <a href="{% url 'evidence_delete' evidence.id %}" class="btn btn-sm btn-outline-danger">Elimina</a>
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted mt-3"><i class="fas fa-info-circle"></i> Nessuna evidenza associata a questo sito.</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Modal for Linking Evidence to this Site -->
                        <div class="modal fade" id="linkSiteEvidenceModal{{ site_data.site.pk }}" tabindex="-1" role="dialog" aria-labelledby="linkSiteEvidenceModalLabel{{ site_data.site.pk }}" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="linkSiteEvidenceModalLabel{{ site_data.site.pk }}">
                                            <i class="fas fa-link"></i> Link Evidence to {{ site_data.site.site_name }}
                                        </h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="form-group">
                                            <label for="siteEvidenceSelect{{ site_data.site.pk }}"><strong>Select Archaeological Evidence</strong></label>
                                            <select class="form-control site-evidence-select" id="siteEvidenceSelect{{ site_data.site.pk }}" data-site-id="{{ site_data.site.pk }}">
                                                <option value="">-- Choose evidence --</option>
                                            </select>
                                            <small class="form-text text-muted">Select archaeological evidence to link to this site</small>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary-modern btn-modern" onclick="linkEvidenceToSite({{ site_data.site.pk }})">
                                            <i class="fas fa-save"></i> Save Relation
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Archaeological Evidence Section -->
        {% if evidences_with_details %}
            <div class="research-card mb-4">
                <div class="section-header section-header-warning d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-shovel"></i>
                        Archaeological Evidence <span class="badge badge-light ml-2">{{ evidences_with_details|length }}</span>
                    </div>
                </div>
                <div class="research-card-body">
                    {% for evidence_data in evidences_with_details %}
                        <div class="evidence-card">
                            <div class="evidence-card-header">
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <h5 class="mb-0">
                                        <i class="fas fa-archway"></i>
                                        {% if evidence_data.evidence.evidence_name %}
                                            {{ evidence_data.evidence.evidence_name }}
                                        {% else %}
                                            Evidence #{{ evidence_data.evidence.id }}
                                        {% endif %}
                                    </h5>
                                    {% if user.is_authenticated %}
                                        {% if user.is_staff or user == research_owner %}
                                            <div class="mt-2 mt-md-0">
                                                <a href="{% url 'evidence_update' evidence_data.evidence.pk %}" class="btn btn-warning-modern btn-modern btn-sm">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                                <a href="{% url 'evidence_delete' evidence_data.evidence.pk %}" class="btn btn-danger-modern btn-modern btn-sm">
                                                    <i class="fas fa-trash"></i> Delete
                                                </a>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="evidence-card-body">
                                <div class="detail-row">
                                    {% if evidence_data.evidence.description %}
                                        <div class="detail-item" style="flex: 1 1 100%;">
                                            <strong><i class="fas fa-align-left"></i> Description</strong>
                                            {{ evidence_data.evidence.description }}
                                        </div>
                                    {% endif %}
                                    {% if evidence_data.evidence.id_country %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-flag"></i> Country</strong>
                                            {{ evidence_data.evidence.id_country }}
                                        </div>
                                    {% endif %}
                                    {% if evidence_data.evidence.id_region %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-map"></i> Region</strong>
                                            {{ evidence_data.evidence.id_region }}
                                        </div>
                                    {% endif %}
                                    {% if evidence_data.evidence.id_municipality %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-city"></i> Municipality</strong>
                                            {{ evidence_data.evidence.id_municipality }}
                                        </div>
                                    {% endif %}
                                    {% if evidence_data.evidence.elevation %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-mountain"></i> Elevation</strong>
                                            {{ evidence_data.evidence.elevation }} m
                                        </div>
                                    {% endif %}
                                    {% if evidence_data.evidence.id_archaeological_evidence_typology %}
                                        <div class="detail-item">
                                            <strong><i class="fas fa-tag"></i> Typology</strong>
                                            {{ evidence_data.evidence.id_archaeological_evidence_typology }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}


        <!-- Modal for Adding Related Sites -->
        <div class="modal fade" id="addResearchSiteModal" tabindex="-1" role="dialog" aria-labelledby="addResearchSiteModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addResearchSiteModalLabel">
                            <i class="fas fa-link"></i> Link Existing Site to Research
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="siteSelect"><strong>Select Site</strong></label>
                            <select class="form-control" id="siteSelect">
                                <option value="">-- Choose a site --</option>
                            </select>
                            <small class="form-text text-muted">Select a site to link to this research</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary-modern btn-modern" onclick="addResearchSiteRelation()">
                            <i class="fas fa-save"></i> Save Relation
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Adding Related Evidence to Research -->
        <div class="modal fade" id="addResearchEvidenceModal" tabindex="-1" role="dialog" aria-labelledby="addResearchEvidenceModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addResearchEvidenceModalLabel">
                            <i class="fas fa-link"></i> Link Existing Archaeological Evidence
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="researchEvidenceSelect"><strong>Select Archaeological Evidence</strong></label>
                            <select class="form-control" id="researchEvidenceSelect">
                                <option value="">-- Choose evidence --</option>
                            </select>
                            <small class="form-text text-muted">Select archaeological evidence to link to this research</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary-modern btn-modern" onclick="addResearchEvidenceRelation()">
                            <i class="fas fa-save"></i> Save Relation
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="mt-4 text-center">
            <a href="{% url 'user-researches' object.submitted_by.username %}" class="btn btn-primary-modern btn-modern">
                <i class="fas fa-arrow-left"></i> Back to My Research
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing modals...');
    
    // TEST: Try loading data immediately on page load to verify functions work
    setTimeout(function() {
        console.log('=== TESTING: Direct call after 1 second ===');
        loadAvailableSites();
        loadAvailableEvidenceForResearch();
    }, 1000);
    
    // Load sites when modal is opened using show.bs.modal
    const addSiteModal = document.getElementById('addResearchSiteModal');
    if (addSiteModal) {
        addSiteModal.addEventListener('show.bs.modal', function() {
            console.log('Site modal opened');
            loadAvailableSites();
        });
        // Also attach to modal shown event as fallback
        addSiteModal.addEventListener('shown.bs.modal', function() {
            console.log('Site modal shown (fallback)');
            if (!addSiteModal._sitesLoaded) {
                loadAvailableSites();
            }
        });
        // Handle focus when modal closes - fix aria-hidden warning
        addSiteModal.addEventListener('hidden.bs.modal', function() {
            console.log('Site modal hidden - restoring focus');
            document.activeElement.blur();
        });
    }
    
    // Load evidence when modal is opened
    const addEvidenceModal = document.getElementById('addResearchEvidenceModal');
    if (addEvidenceModal) {
        addEvidenceModal.addEventListener('show.bs.modal', function() {
            console.log('Evidence modal opened');
            loadAvailableEvidenceForResearch();
        });
        // Also attach to modal shown event as fallback
        addEvidenceModal.addEventListener('shown.bs.modal', function() {
            console.log('Evidence modal shown (fallback)');
            if (!addEvidenceModal._evidenceLoaded) {
                loadAvailableEvidenceForResearch();
            }
        });
        // Handle focus when modal closes - fix aria-hidden warning
        addEvidenceModal.addEventListener('hidden.bs.modal', function() {
            console.log('Evidence modal hidden - restoring focus');
            document.activeElement.blur();
        });
    }
    
    // Load evidence for all site-evidence modals
    document.querySelectorAll('[id^="linkSiteEvidenceModal"]').forEach(function(modal) {
        modal.addEventListener('show.bs.modal', function() {
            const selectElement = modal.querySelector('.site-evidence-select');
            if (selectElement) {
                loadEvidenceForSite(selectElement);
            }
        });
        // Handle focus when modal closes
        modal.addEventListener('hidden.bs.modal', function() {
            document.activeElement.blur();
        });
    });
    
    // Preload evidence for site modals on page load (covers cases where modal event does not fire)
    preloadEvidenceForAllSiteSelects();
});

// Cache evidence list to avoid repeated fetches
let _cachedEvidenceList = null;
let _cachedEvidencePromise = null;

function preloadEvidenceForAllSiteSelects() {
    const selects = document.querySelectorAll('.site-evidence-select');
    if (!selects.length) return;
    loadEvidenceForSiteSelects(selects);
}

function loadEvidenceForSiteSelects(selectNodeList) {
    // Reuse cache if available
    if (_cachedEvidenceList) {
        selectNodeList.forEach(sel => populateEvidenceSelect(sel, _cachedEvidenceList));
        return;
    }
    // Reuse in-flight promise to prevent duplicate requests
    if (_cachedEvidencePromise) {
        _cachedEvidencePromise.then(list => {
            selectNodeList.forEach(sel => populateEvidenceSelect(sel, list));
        }).catch(err => {
            console.error('❌ Error loading evidence (cached promise):', err);
        });
        return;
    }
    _cachedEvidencePromise = fetch('{% url "api-evidence-list" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const list = (data && Array.isArray(data.results)) ? data.results : [];
        _cachedEvidenceList = list;
        selectNodeList.forEach(sel => populateEvidenceSelect(sel, list));
        return list;
    })
    .catch(err => {
        console.error('❌ Error preloading evidence:', err);
        selectNodeList.forEach(sel => sel.innerHTML = '<option value="">Error loading evidence</option>');
    });
}

function loadAvailableSites() {
    console.log('=== LOADING SITES ===');
    const siteSelect = document.getElementById('siteSelect');
    console.log('1. siteSelect element:', siteSelect);
    
    if (!siteSelect) {
        console.error('❌ siteSelect element not found');
        return;
    }
    
    console.log('2. siteSelect found - current options:', siteSelect.options.length);
    console.log('3. Fetching from: {% url "api-sites-list" %}');
    
    fetch('{% url "api-sites-list" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('4. Response received - Status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('5. Data received:', data);
        console.log('6. data.results:', data.results);
        console.log('7. Is array?', Array.isArray(data.results));
        console.log('8. Length:', data.results ? data.results.length : 'N/A');
        
        // Clear existing options (keep the placeholder)
        siteSelect.innerHTML = '<option value="">-- Choose a site --</option>';
        console.log('9. Cleared dropdown, options count:', siteSelect.options.length);
        
        // Add sites to dropdown
        if (data && data.results && Array.isArray(data.results) && data.results.length > 0) {
            console.log(`10. Adding ${data.results.length} sites...`);
            data.results.forEach((site, idx) => {
                const option = document.createElement('option');
                option.value = site.id;
                const displayName = site.site_name || `Site #${site.id}`;
                const locality = site.locality_name ? ` (${site.locality_name})` : '';
                option.textContent = displayName + locality;
                siteSelect.appendChild(option);
                console.log(`   [${idx + 1}] Added: "${option.textContent}" (value: ${option.value})`);
            });
            console.log('11. Final options count:', siteSelect.options.length);
            console.log('✅ Sites loaded successfully!');
            document.getElementById('addResearchSiteModal')._sitesLoaded = true;
        } else {
            console.warn('❌ No sites found in API response');
            siteSelect.innerHTML = '<option value="">-- No sites available in database --</option>';
        }
    })
    .catch(error => {
        console.error('❌ Error loading sites:', error);
        siteSelect.innerHTML = '<option value="">Error loading sites</option>';
    });
}

function addResearchSiteRelation() {
    const siteSelect = document.getElementById('siteSelect');
    const siteId = siteSelect.value;
    const researchId = {{ object.id }};
    
    if (!siteId) {
        alert('Please select a site');
        return;
    }
    
    fetch('{% url "api-site-research-create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            id_site: siteId,
            id_research: researchId
        })
    })
    .then(response => {
        if (response.ok) {
            alert('Site linked successfully!');
            document.getElementById('addResearchSiteModal').querySelector('.close').click();
            // Reload page to show new relation
            location.reload();
        } else if (response.status === 400) {
            return response.json().then(data => {
                throw new Error(data.error || 'This relation already exists');
            });
        } else {
            throw new Error('Failed to create relation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadAvailableEvidenceForResearch() {
    console.log('=== LOADING EVIDENCE ===');
    const evidenceSelect = document.getElementById('researchEvidenceSelect');
    console.log('1. evidenceSelect element:', evidenceSelect);
    
    if (!evidenceSelect) {
        console.error('❌ researchEvidenceSelect element not found');
        return;
    }
    
    console.log('2. evidenceSelect found - current options:', evidenceSelect.options.length);
    console.log('3. Fetching from: {% url "api-evidence-list" %}');
    
    fetch('{% url "api-evidence-list" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('4. Response received - Status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('5. Data received:', data);
        console.log('6. data.results:', data.results);
        console.log('7. Is array?', Array.isArray(data.results));
        console.log('8. Length:', data.results ? data.results.length : 'N/A');
        
        // Clear existing options (keep the placeholder)
        evidenceSelect.innerHTML = '<option value="">-- Choose evidence --</option>';
        console.log('9. Cleared dropdown, options count:', evidenceSelect.options.length);
        
        // Add evidence to dropdown
        if (data && data.results && Array.isArray(data.results) && data.results.length > 0) {
            console.log(`10. Adding ${data.results.length} evidence items...`);
            data.results.forEach((evidence, idx) => {
                const option = document.createElement('option');
                option.value = evidence.id;
                const displayName = evidence.evidence_name || `Evidence #${evidence.id}`;
                const description = evidence.description ? ` - ${evidence.description.substring(0, 40)}...` : '';
                option.textContent = displayName + description;
                evidenceSelect.appendChild(option);
                console.log(`   [${idx + 1}] Added: "${option.textContent}" (value: ${option.value})`);
            });
            console.log('11. Final options count:', evidenceSelect.options.length);
            console.log('✅ Evidence loaded successfully!');
            document.getElementById('addResearchEvidenceModal')._evidenceLoaded = true;
        } else {
            console.warn('❌ No evidence found in API response');
            evidenceSelect.innerHTML = '<option value="">-- No evidence available in database --</option>';
        }
    })
    .catch(error => {
        console.error('❌ Error loading evidence:', error);
        evidenceSelect.innerHTML = '<option value="">Error loading evidence</option>';
    });
}

function addResearchEvidenceRelation() {
    const evidenceSelect = document.getElementById('researchEvidenceSelect');
    const evidenceId = evidenceSelect.value;
    const researchId = {{ object.id }};
    
    if (!evidenceId) {
        alert('Please select evidence');
        return;
    }
    
    fetch('{% url "api-research-evidence-create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            id_research: researchId,
            id_archaeological_evidence: evidenceId
        })
    })
    .then(response => {
        if (response.ok) {
            alert('Evidence linked successfully!');
            document.getElementById('addResearchEvidenceModal').querySelector('.close').click();
            // Reload page to show new relation
            location.reload();
        } else if (response.status === 400) {
            return response.json().then(data => {
                throw new Error(data.error || 'This relation already exists');
            });
        } else {
            throw new Error('Failed to create relation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function loadEvidenceForSite(selectElement) {
    console.log('=== LOADING EVIDENCE FOR SITE ===');
    console.log('Select element:', selectElement);
    
    if (!selectElement) {
        console.error('❌ Select element not found');
        return;
    }
    
    // If already cached, reuse
    if (_cachedEvidenceList) {
        populateEvidenceSelect(selectElement, _cachedEvidenceList);
        return;
    }
    // If a fetch is already in-flight, wait and then populate
    if (_cachedEvidencePromise) {
        _cachedEvidencePromise.then(list => populateEvidenceSelect(selectElement, list));
        return;
    }
    // Otherwise, trigger preload for all selects (including this one)
    loadEvidenceForSiteSelects([selectElement]);
}

function populateEvidenceSelect(selectElement, evidenceList) {
    // Clear existing options
    selectElement.innerHTML = '<option value="">-- Choose evidence --</option>';
    if (Array.isArray(evidenceList) && evidenceList.length > 0) {
        evidenceList.forEach((evidence, idx) => {
            const option = document.createElement('option');
            option.value = evidence.id;
            const displayName = evidence.evidence_name || `Evidence #${evidence.id}`;
            const description = evidence.description ? ` - ${evidence.description.substring(0, 40)}...` : '';
            option.textContent = displayName + description;
            selectElement.appendChild(option);
        });
    } else {
        selectElement.innerHTML = '<option value="">-- No evidence available --</option>';
    }
}

function linkEvidenceToSite(siteId) {
    const evidenceSelect = document.getElementById('siteEvidenceSelect' + siteId);
    const evidenceId = evidenceSelect.value;
    
    if (!evidenceId) {
        alert('Please select evidence');
        return;
    }
    
    console.log(`Linking evidence ${evidenceId} to site ${siteId}`);
    
    fetch('{% url "api-site-evidence-create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            id_site: siteId,
            id_archaeological_evidence: evidenceId
        })
    })
    .then(response => {
        if (response.ok) {
            alert('Evidence linked to site successfully!');
            const modal = document.getElementById('linkSiteEvidenceModal' + siteId);
            modal.querySelector('.close').click();
            // Reload page to show new relation
            location.reload();
        } else if (response.status === 400) {
            return response.json().then(data => {
                throw new Error(data.error || 'This relation already exists');
            });
        } else {
            throw new Error('Failed to create relation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock content %}
